name: "Infrastructure"

on:
  push:
    branches: ["main"]
    paths:
      - "terraform/**"
  pull_request:
    branches: ["main"]
    paths:
      - "terraform/**"

permissions:
  id-token: write
  contents: read

jobs:
  plan:
    name: "Terraform Plan"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./terraform

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActionsProvisionerRole
          aws-region: us-west-2

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "latest"

      - name: Install AWS SSM Session Manager Plugin
        run: |
          curl "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb" -o "session-manager-plugin.deb"
          sudo dpkg -i session-manager-plugin.deb

      - name: Get Bastion Instance ID and EKS Endpoint
        id: get-bastion-eks-info
        run: |
          # Get bastion instance ID
          BASTION_INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=wiz-exercise-bastion" "Name=instance-state-name,Values=running" \
            --query "Reservations[].Instances[].InstanceId" \
            --output text | head -n 1)
          
          if [ -z "$BASTION_INSTANCE_ID" ]; then
            echo "Error: Bastion instance not found or not running."
            exit 1
          fi
          echo "BASTION_INSTANCE_ID=$BASTION_INSTANCE_ID" >> $GITHUB_ENV

          # Get EKS Cluster Endpoint
          EKS_ENDPOINT=$(aws eks describe-cluster \
            --name wiz-exercise-eks \
            --query "cluster.endpoint" \
            --output text)
          
          if [ -z "$EKS_ENDPOINT" ]; then
            echo "Error: EKS cluster endpoint not found."
            exit 1
          fi
          echo "EKS_ENDPOINT=$EKS_ENDPOINT" >> $GITHUB_ENV

      - name: Start SSM Port Forwarding to EKS
        run: |
          EKS_ENDPOINT_CLEAN=$(echo ${{ env.EKS_ENDPOINT }} | sed 's|^https://||')
          echo "Forwarding to EKS endpoint: $EKS_ENDPOINT_CLEAN via ${{ env.BASTION_INSTANCE_ID }}"
          # Run in background, store PID
          aws ssm start-session \
            --target "${{ env.BASTION_INSTANCE_ID }}" \
            --document-name AWS-StartPortForwardingSessionToRemoteHost \
            --parameters "host=$EKS_ENDPOINT_CLEAN,portNumber=443,localPortNumber=6443" &
          SSM_SESSION_PID=$!
          echo "SSM_SESSION_PID=$SSM_SESSION_PID" >> $GITHUB_ENV
          echo "SSM Port forwarding session started with PID: $SSM_SESSION_PID"
          sleep 10 # Give the tunnel some time to establish
        
      - name: Update Kubeconfig for Port Forwarding
        run: |
          # Use the EKS endpoint directly for initial kubeconfig setup
          aws eks update-kubeconfig --name wiz-exercise-eks --region us-west-2
          
          # Modify kubeconfig to use the local forwarded port
          kubectl config set-cluster arn:aws:eks:us-west-2:${{ secrets.AWS_ACCOUNT_ID }}:cluster/wiz-exercise-eks \
            --server=https://localhost:6443 \
            --insecure-skip-tls-verify=true
          
          echo "Kubeconfig updated to use local port-forwarding (localhost:6443)."

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: terraform/
          soft_fail: true
          framework: terraform

      - name: Terraform Init
        run: |
          export KUBECONFIG=~/.kube/config # Ensure Terraform uses the modified kubeconfig
          terraform init

      - name: Terraform Plan
        id: plan
        run: |
          export KUBECONFIG=~/.kube/config # Ensure Terraform uses the modified kubeconfig
          terraform plan -input=false -out=tfplan
        env:
          TF_VAR_admin_user_name: ${{ secrets.ADMIN_USER_NAME }}

      - name: Upload Plan
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: terraform/
      
      - name: Terminate SSM Port Forwarding Session
        if: always() # Run always, even if previous steps fail
        run: |
          if [ -n "${{ env.SSM_SESSION_PID }}" ]; then
            echo "Terminating SSM session with PID: ${{ env.SSM_SESSION_PID }}"
            kill ${{ env.SSM_SESSION_PID }} || true
            echo "SSM session terminated."
          else
            echo "No active SSM session PID found to terminate."
          fi

  apply:
    name: "Terraform Apply"
    needs: plan
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: production
    defaults:
      run:
        working-directory: ./terraform

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActionsProvisionerRole
          aws-region: us-west-2

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "latest"

      - name: Install AWS SSM Session Manager Plugin
        run: |
          curl "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb" -o "session-manager-plugin.deb"
          sudo dpkg -i session-manager-plugin.deb

      - name: Get Bastion Instance ID and EKS Endpoint
        id: get-bastion-eks-info
        run: |
          # Get bastion instance ID
          BASTION_INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=wiz-exercise-bastion" "Name=instance-state-name,Values=running" \
            --query "Reservations[].Instances[].InstanceId" \
            --output text | head -n 1)
          
          if [ -z "$BASTION_INSTANCE_ID" ]; then
            echo "Error: Bastion instance not found or not running."
            exit 1
          fi
          echo "BASTION_INSTANCE_ID=$BASTION_INSTANCE_ID" >> $GITHUB_ENV

          # Get EKS Cluster Endpoint
          EKS_ENDPOINT=$(aws eks describe-cluster \
            --name wiz-exercise-eks \
            --query "cluster.endpoint" \
            --output text)
          
          if [ -z "$EKS_ENDPOINT" ]; then
            echo "Error: EKS cluster endpoint not found."
            exit 1
          fi
          echo "EKS_ENDPOINT=$EKS_ENDPOINT" >> $GITHUB_ENV

      - name: Start SSM Port Forwarding to EKS
        run: |
          EKS_ENDPOINT_CLEAN=$(echo ${{ env.EKS_ENDPOINT }} | sed 's|^https://||')
          echo "Forwarding to EKS endpoint: $EKS_ENDPOINT_CLEAN via ${{ env.BASTION_INSTANCE_ID }}"
          # Run in background, store PID
          aws ssm start-session \
            --target "${{ env.BASTION_INSTANCE_ID }}" \
            --document-name AWS-StartPortForwardingSessionToRemoteHost \
            --parameters "host=$EKS_ENDPOINT_CLEAN,portNumber=443,localPortNumber=6443" &
          SSM_SESSION_PID=$!
          echo "SSM_SESSION_PID=$SSM_SESSION_PID" >> $GITHUB_ENV
          echo "SSM Port forwarding session started with PID: $SSM_SESSION_PID"
          sleep 10 # Give the tunnel some time to establish
        
      - name: Update Kubeconfig for Port Forwarding
        run: |
          # Use the EKS endpoint directly for initial kubeconfig setup
          aws eks update-kubeconfig --name wiz-exercise-eks --region us-west-2
          
          # Modify kubeconfig to use the local forwarded port
          kubectl config set-cluster arn:aws:eks:us-west-2:${{ secrets.AWS_ACCOUNT_ID }}:cluster/wiz-exercise-eks \
            --server=https://localhost:6443 \
            --insecure-skip-tls-verify=true
          
          echo "Kubeconfig updated to use local port-forwarding (localhost:6443)."

      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan
          path: terraform/

      - name: Terraform Init
        run: |
          export KUBECONFIG=~/.kube/config # Ensure Terraform uses the modified kubeconfig
          terraform init

      - name: Terraform Apply
        run: |
          export KUBECONFIG=~/.kube/config # Ensure Terraform uses the modified kubeconfig
          terraform apply -auto-approve tfplan
      
      - name: Terminate SSM Port Forwarding Session
        if: always() # Run always, even if previous steps fail
        run: |
          if [ -n "${{ env.SSM_SESSION_PID }}" ]; then
            echo "Terminating SSM session with PID: ${{ env.SSM_SESSION_PID }}"
            kill ${{ env.SSM_SESSION_PID }} || true
            echo "SSM session terminated."
          else
            echo "No active SSM session PID found to terminate."
          fi
